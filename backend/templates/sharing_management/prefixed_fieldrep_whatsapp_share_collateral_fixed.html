{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <!-- Left Sidebar - Collateral Selection -->
    <div class="col-12 col-lg-4 mb-4 mb-lg-0">
      <div class="card shadow">
        <div class="card-header">
          <h6 class="mb-0">Share Collateral via WhatsApp</h6>
        </div>
        <div class="card-body">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
          
          <form method="post" autocomplete="off" id="shareForm">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Field ID:</label>
              <input type="text" class="form-control" name="fieldrep_id" value="{{ fieldrep_id }}" readonly>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Select Doctor:</label>
              {% if doctors %}
                <select class="form-select" name="doctor_id" id="doctorSelect" required>
                  <option value="">Select Doctor</option>
                  {% for d in doctors %}
                  <option value="{{ d.id }}" data-name="{{ d.name }}" data-phone="{{ d.phone }}">
                    {{ d.name }} / {{ d.phone }}
                  </option>
                  {% endfor %}
                </select>
              {% else %}
                <div class="alert alert-warning">
                  No doctors found assigned to your account. Please contact support.
                </div>
                <select class="form-select" name="doctor_id" id="doctorSelect" disabled>
                  <option value="">No doctors available</option>
                </select>
              {% endif %}
            </div>
            
            <div class="mb-3">
              <label class="form-label">Name of Doctor:</label>
              <input type="text" class="form-control" id="doctorName" name="doctor_name" readonly>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Doctor Phone Number:</label>
              <input type="text" class="form-control" id="doctorPhone" name="doctor_phone" readonly>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Select Collateral:</label>
              {% if collaterals %}
                <select class="form-select" name="collateral" id="collateralSelect" required>
                  <option value="">Select Collateral</option>
                  {% for c in collaterals %}
                  <option value="{{ c.id }}" {% if c.id == selected_collateral_id %}selected{% endif %}>
                    {{ c.title }}
                  </option>
                  {% endfor %}
                </select>
              {% else %}
                <div class="alert alert-warning">
                  No active collaterals found. Please contact support if you believe this is an error.
                </div>
                <select class="form-select" name="collateral" disabled>
                  <option value="">No collaterals available</option>
                </select>
              {% endif %}
            </div>
            
            <button type="submit" class="btn btn-primary w-100" style="background:#25D366; border:none;">
              <i class="fab fa-whatsapp me-2"></i>Send WhatsApp Message
            </button>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Right Side - Assigned Doctors List -->
    <div class="col-12 col-lg-8">
      <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Assigned Doctors</h6>
          <div class="d-flex gap-2">
            <input type="text" id="doctorSearch" class="form-control form-control-sm" placeholder="Search by name or phone">
            <select id="statusFilter" class="form-select form-select-sm" style="width:auto;">
              <option value="">All</option>
              <option value="not_shared">Not Shared</option>
              <option value="shared">Shared</option>
              <option value="viewed">Viewed</option>
              <option value="needs_reminder">Needs Reminder</option>
            </select>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="doctorList">
            {% for d in doctors %}
            <div class="list-group-item d-flex justify-content-between align-items-center doctor-row"
                 data-id="{{ d.id }}"
                 data-name="{{ d.name|lower }}" 
                 data-phone="{{ d.phone|default:'' }}" 
                 data-status="{{ d.status|default:'not_shared' }}"
                 data-last-shared="{{ d.last_shared|date:'c'|default:'' }}">
              <div>
                <div class="fw-semibold">{{ d.name|default:'Unnamed Doctor' }}</div>
                <div class="text-muted small">
                  {{ d.phone|default:'No phone' }} 
                  {% if d.specialty %}| {{ d.specialty }}{% endif %}
                  {% if d.city %}| {{ d.city }}{% endif %}
                </div>
                <div class="last-shared-time text-muted small mt-1" style="display: none;">
                  Last shared: <span class="time-ago"></span>
                </div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <form method="post" class="m-0 share-form" data-doctor-id="{{ d.id }}">
                  {% csrf_token %}
                  <input type="hidden" name="doctor_id" value="{{ d.id }}">
                  <input type="hidden" name="collateral" value="{{ selected_collateral_id }}">
                  <button type="submit" class="btn btn-sm" data-status="{{ d.status|default:'not_shared' }}">
                    {% if d.status == 'viewed' %}
                      <i class="fas fa-check-circle me-1"></i> Viewed
                    {% elif d.status == 'needs_reminder' %}
                      <i class="fas fa-bell me-1"></i> Send Reminder
                    {% elif d.status == 'shared' %}
                      <i class="fas fa-paper-plane me-1"></i> Shared
                    {% else %}
                      <i class="fas fa-paper-plane me-1"></i> Send Message
                    {% endif %}
                  </button>
                </form>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Button styles */
  .btn[data-status="not_shared"] {
    background-color: #dc3545;
    color: white;
    border: none;
  }
  
  .btn[data-status="shared"] {
    background-color: #ffc107;
    color: #000;
    border: none;
    opacity: 0.7;
  }
  
  .btn[data-status="viewed"] {
    background-color: #198754;
    color: white;
    border: none;
    opacity: 0.7;
  }
  
  .btn[data-status="needs_reminder"] {
    background-color: #6f42c1;
    color: white;
    border: none;
  }
  
  .btn:disabled {
    opacity: 0.7;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    const doctorSelect = document.getElementById('doctorSelect');
    const doctorName = document.getElementById('doctorName');
    const doctorPhone = document.getElementById('doctorPhone');
    const searchInput = document.getElementById('doctorSearch');
    const statusFilter = document.getElementById('statusFilter');
    const doctorRows = document.querySelectorAll('.doctor-row');
    
    // Initialize doctor select dropdown
    if (doctorSelect) {
      doctorSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (doctorName) doctorName.value = selectedOption.getAttribute('data-name') || '';
        if (doctorPhone) doctorPhone.value = selectedOption.getAttribute('data-phone') || '';
      });
      
      // Trigger change if there's a selected value
      if (doctorSelect.value) {
        doctorSelect.dispatchEvent(new Event('change'));
      }
    }
    
    // Handle form submissions
    document.querySelectorAll('.share-form').forEach(form => {
      form.addEventListener('submit', handleFormSubmit);
    });
    
    // Search and filter functionality
    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
    }
    
    if (statusFilter) {
      statusFilter.addEventListener('change', applyFilters);
    }
    
    // Initial filters and checks
    applyFilters();
    checkForReminders();
    
    // Check for reminders every hour
    setInterval(checkForReminders, 60 * 60 * 1000);
    
    // Main form submission handler
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const form = e.target;
      const button = form.querySelector('button[type="submit"]');
      const row = form.closest('.doctor-row');
      
      if (!button || button.disabled) return;
      
      // Save original button state
      const originalHTML = button.innerHTML;
      const originalStatus = button.getAttribute('data-status');
      
      try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
        
        // Get form data
        const formData = new FormData(form);
        const doctorPhone = formData.get('doctor_phone') || '';
        const message = formData.get('message') || '';
        
        // Clean phone number
        const cleanPhone = doctorPhone.replace(/\D/g, '');
        
        if (!cleanPhone) {
          throw new Error('Invalid phone number');
        }
        
        // Create WhatsApp URL
        const waUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
        
        // Open WhatsApp in a new tab
        const waWindow = window.open(waUrl, '_blank');
        
        // Update UI immediately for better UX
        if (row) {
          updateDoctorStatus(row, 'shared');
          
          // Schedule reminder check
          setTimeout(() => {
            if (row.getAttribute('data-status') === 'shared') {
              updateDoctorStatus(row, 'needs_reminder');
            }
          }, 6 * 24 * 60 * 60 * 1000); // 6 days
        }
        
        // Send tracking request to server
        try {
          const response = await fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
          });
          
          const data = await response.json();
          
          if (!data.success) {
            console.error('Tracking failed:', data.message);
            // Revert UI on error
            if (row) {
              updateDoctorStatus(row, originalStatus);
            }
            throw new Error(data.message || 'Failed to track message');
          }
          
        } catch (error) {
          console.error('Error tracking share:', error);
          // Don't revert UI for tracking errors, as the message was still sent
        }
        
        // Focus WhatsApp window
        if (waWindow) {
          setTimeout(() => waWindow.focus(), 500);
        }
        
      } catch (error) {
        console.error('Error:', error);
        
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'alert alert-danger mt-2 mb-0 py-1';
        errorMsg.textContent = 'Failed to send message. Please try again.';
        form.parentNode.insertBefore(errorMsg, form.nextSibling);
        
        // Remove error message after 5 seconds
        setTimeout(() => {
          errorMsg.remove();
        }, 5000);
        
        // Revert button state
        if (button) {
          button.disabled = false;
          button.innerHTML = originalHTML;
        }
      }
    }
    
    // Update doctor status in the UI
    function updateDoctorStatus(row, status) {
      if (!row || !status) return;
      
      // Update data attributes
      row.setAttribute('data-status', status);
      
      if (status === 'shared' || status === 'viewed') {
        const now = new Date().toISOString();
        row.setAttribute('data-last-shared', now);
        
        // Update last shared time display
        const lastSharedDiv = row.querySelector('.last-shared-time');
        const timeAgoSpan = row.querySelector('.time-ago');
        
        if (lastSharedDiv && timeAgoSpan) {
          lastSharedDiv.style.display = 'block';
          timeAgoSpan.textContent = 'just now';
          updateTimeAgo(row);
        }
      }
      
      // Update button
      const button = row.querySelector('button[type="submit"]');
      if (button) {
        button.setAttribute('data-status', status);
        
        switch (status) {
          case 'shared':
            button.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Shared';
            button.disabled = true;
            break;
            
          case 'viewed':
            button.innerHTML = '<i class="fas fa-check-circle me-1"></i> Viewed';
            button.disabled = true;
            break;
            
          case 'needs_reminder':
            button.innerHTML = '<i class="fas fa-bell me-1"></i> Send Reminder';
            button.disabled = false;
            break;
            
          default: // not_shared
            button.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Send Message';
            button.disabled = false;
        }
      }
    }
    
    // Update time ago for all shared/updated doctors
    function updateTimeAgo(row) {
      const timeAgoSpan = row.querySelector('.time-ago');
      const lastShared = row.getAttribute('data-last-shared');
      
      if (!timeAgoSpan || !lastShared) return;
      
      const lastDate = new Date(lastShared);
      const now = new Date();
      const diffMs = now - lastDate;
      
      // Convert to appropriate time unit
      const diffSecs = Math.floor(diffMs / 1000);
      const diffMins = Math.floor(diffSecs / 60);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      let timeAgo;
      if (diffSecs < 60) {
        timeAgo = 'just now';
      } else if (diffMins < 60) {
        timeAgo = `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
      } else if (diffHours < 24) {
        timeAgo = `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
      } else {
        timeAgo = `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
      }
      
      timeAgoSpan.textContent = timeAgo;
    }
    
    // Check for reminders (6 days after sharing)
    function checkForReminders() {
      const now = new Date();
      
      document.querySelectorAll('.doctor-row[data-last-shared]').forEach(row => {
        const lastShared = row.getAttribute('data-last-shared');
        const status = row.getAttribute('data-status');
        
        if (!lastShared || status !== 'shared') return;
        
        const lastDate = new Date(lastShared);
        const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
        
        if (diffDays >= 6) {
          updateDoctorStatus(row, 'needs_reminder');
        } else {
          // Update time display
          updateTimeAgo(row);
        }
      });
    }
    
    // Apply search and filter
    function applyFilters() {
      const searchTerm = (searchInput?.value || '').toLowerCase();
      const statusFilterValue = statusFilter?.value || '';
      
      doctorRows.forEach(row => {
        const name = (row.getAttribute('data-name') || '').toLowerCase();
        const phone = (row.getAttribute('data-phone') || '').toLowerCase();
        const status = row.getAttribute('data-status') || '';
        
        const matchesSearch = !searchTerm || 
                             name.includes(searchTerm) || 
                             phone.includes(searchTerm);
        
        const matchesStatus = !statusFilterValue || status === statusFilterValue;
        
        row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
      });
    }
    
    // Update all time-ago displays every minute
    setInterval(() => {
      document.querySelectorAll('.doctor-row[data-last-shared]').forEach(updateTimeAgo);
    }, 60000);
  });
</script>
{% endblock %}
