{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container mt-4">
  <div class="card mx-auto shadow-sm" style="max-width: 900px">

    <!-- ✅ 1) Title + Description + Doctor Name -->
    <div class="card-header text-center">
      <h4 class="mb-0">{{ collateral.title }}</h4>

      {% if collateral.description %}
        <p class="text-muted mb-0">{{ collateral.description }}</p>
      {% endif %}

      {% if doctor_obj and doctor_obj.name %}
        <p class="text-muted mb-0">By Dr. {{ doctor_obj.name }}</p>
      {% elif collateral.doctor_name %}
        <p class="text-muted mb-0">By Dr. {{ collateral.doctor_name }}</p>
      {% endif %}
    </div>

    <div class="card-body text-center">

      <!-- ✅ 2) Banner 1 -->
      {% if collateral.banner_1 %}
        <div class="mb-4">
          <img
            src="{{ collateral.banner_1.url }}"
            alt="Banner 1"
            class="img-fluid w-100 rounded"
            style="object-fit: cover; max-height: 320px;"
          />
        </div>
      {% endif %}

      <!-- ✅ 3) Video -->
      {% if collateral.vimeo_url %}
        <div class="ratio ratio-16x9 mb-4">
          {% if "vimeo.com" in collateral.vimeo_url %}
            <iframe src="{{ collateral.vimeo_url }}" allowfullscreen></iframe>
          {% else %}
            <iframe src="https://player.vimeo.com/video/{{ collateral.vimeo_url }}" allowfullscreen></iframe>
          {% endif %}
        </div>
      {% endif %}

      <!-- ✅ 4) PDF -->
      {% if collateral.file %}
        <a
          href="{{ absolute_pdf_url|default:'#' }}"
          class="btn btn-primary mb-3"
          target="_blank"
          rel="noopener"
          style="background: #1877f2; border: none"
        >
          <i class="bi bi-download me-2"></i>CLICK HERE to download PDF
        </a>

        <p class="text-muted mb-3">If you are not able to see the PDF, please refresh the page!</p>

        <div
          class="pdf-container mb-4"
          style="
            border: 1px solid var(--border-color);
            height: 600px;
            overflow: hidden;
            position: relative;
            background: var(--background-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
          "
        >
          <iframe
            src="{{ absolute_pdf_url|default:'about:blank' }}#toolbar=0&navpanes=0&scrollbar=0"
            width="100%"
            height="100%"
            style="border: none; border-radius: var(--radius-lg);"
            title="{{ collateral.title }} PDF"
          ></iframe>
        </div>
      {% endif %}

      <!-- 5) Webinar -->
      {% if collateral.webinar_title or collateral.webinar_url or collateral.webinar_description or collateral.webinar_date %}
        <hr class="my-4" />
        <div class="text-start">
          <h5 class="mb-3">Webinar</h5>

          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">
                    {{ collateral.webinar_title|default:"Learning Webinar" }}
                  </h6>

                  {% if collateral.webinar_date %}
                    <small class="text-muted">
                      {{ collateral.webinar_date|date:"F Y" }}
                    </small>
                  {% endif %}

                  {% if collateral.webinar_description %}
                    <p class="mt-2 mb-0">{{ collateral.webinar_description }}</p>
                  {% endif %}
                </div>

                {% if collateral.webinar_url %}
                  <a
                    class="btn btn-outline-primary"
                    href="{{ collateral.webinar_url }}"
                    target="_blank"
                    rel="noopener"
                  >
                    View on DIAP
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- ✅ 6) Banner 2 -->
      {% if collateral.banner_2 %}
        <div class="mt-4">
          <img
            src="{{ collateral.banner_2.url }}"
            alt="Banner 2"
            class="img-fluid w-100 rounded"
            style="object-fit: cover; max-height: 220px;"
          />
        </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- ✅ Engagement logger -->
<script type="application/json" id="engagementId">
  {{ engagement_id|json_script:"engagementId" }}
</script>

<script>
  const engagement = JSON.parse(document.getElementById("engagementId").textContent);

  function logEngagement(payload) {
    payload.engagement_id = engagement;
    fetch("{% url 'doctor_view_log' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
  }
</script>

{% endblock %}
