{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
  /* Prevent accidental horizontal scroll from any embedded content */
  .collateral-page,
  .collateral-page .card,
  .collateral-page .card-body,
  .collateral-page img,
  .collateral-page iframe {
    max-width: 100%;
  }

  /* Buttons in Bootstrap often default to nowrap -> can cause overflow on small screens */
  .btn-wrap {
    white-space: normal !important;
    word-break: break-word;
  }

  /* PDF container: flex column so controls + viewer always fit without calc() */
  .pdf-container {
    border: 1px solid #ccc;
    background: #f8f9fa;
    border-radius: 8px;

    /* Responsive height (better than fixed 600px on small devices) */
    height: 70vh;
    max-height: 600px;
    min-height: 420px;

    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .pdf-controls {
    background: #fff;
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }

  /* Only vertical scrolling; no horizontal scrolling */
  .pdf-scroll {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* iframe width trick: prevents some mobile browsers from creating extra width */
  .pdf-frame {
    display: block;
    width: 1px;
    min-width: 100%;
    height: 100%;
    border: 0;
  }

  @media (max-width: 576px) {
    .pdf-container {
      min-height: 360px;
      height: 65vh;
    }
  }
</style>

<div class="container mt-4 collateral-page">
  <div class="card mx-auto shadow-sm" style="max-width: 900px; width: 100%;">
    <div class="card-body text-center">

      <!-- ✅ 1) Banner 1 -->
      {% if collateral.banner_1 %}
        <div class="mb-4">
          <img
            src="{{ collateral.banner_1.url }}"
            alt="Banner 1"
            class="img-fluid w-100 rounded"
            style="object-fit: cover; max-height: 320px;"
          />
        </div>
      {% endif %}

      <!-- ✅ 2) Title -->
      <h4 class="mb-2">{{ collateral.title }}</h4>

      <!-- ✅ 3) Doctor Details -->
      {% if collateral.description %}
        <p class="text-muted mb-1">{{ collateral.description }}</p>
      {% endif %}

      {% if doctor_obj and doctor_obj.name %}
        <p class="text-muted mb-4">By Dr. {{ doctor_obj.name }}</p>
      {% elif collateral.doctor_name %}
        <p class="text-muted mb-4">By Dr. {{ collateral.doctor_name }}</p>
      {% else %}
        <p class="text-muted mb-4"></p>
      {% endif %}

      <!-- ✅ 4) Video -->
      {% if collateral.vimeo_url %}
        <div class="ratio ratio-16x9 mb-4">
          {% if "vimeo.com" in collateral.vimeo_url %}
            <iframe src="{{ collateral.vimeo_url }}" allowfullscreen></iframe>
          {% else %}
            <iframe src="https://player.vimeo.com/video/{{ collateral.vimeo_url }}" allowfullscreen></iframe>
          {% endif %}
        </div>
      {% endif %}

      <!-- ✅ 5) PDF -->
      {% if collateral.file %}
        <!-- On small screens this becomes stacked (grid), on larger screens centered inline (flex) -->
        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mb-3">
          <a
            href="{{ absolute_pdf_url|default:'#' }}"
            class="btn btn-primary btn-wrap"
            target="_blank"
            rel="noopener"
            style="background: #1877f2; border: none"
          >
            CLICK HERE to download the PDF
          </a>
        </div>

        <p class="text-muted">If you are not able to see the PDF, please refresh the page!</p>

        <div class="pdf-container mb-4">
          <!-- Controls: stack on xs, row on sm+ -->
          <div class="pdf-controls d-grid gap-2 d-sm-flex justify-content-sm-center align-items-center">
            <a
              href="{{ absolute_pdf_url|default:'#' }}"
              class="btn btn-outline-secondary btn-sm btn-wrap"
              target="_blank"
              rel="noopener"
            >
              Open in New Tab
            </a>

            <a
              href="{{ absolute_pdf_url|default:'#' }}"
              class="btn btn-outline-success btn-sm btn-wrap"
              download
            >
              Download
            </a>
          </div>

          <div class="pdf-scroll">
            <iframe
              class="pdf-frame"
              title="PDF Viewer"
              src="{{ absolute_pdf_url|default:'about:blank' }}#view=FitH&zoom=page-width"
            ></iframe>
          </div>
        </div>
      {% endif %}

      <!-- ✅ 6) Archives -->
      {% if collateral.archive_file %}
        <hr class="my-4" />
        <div class="text-start">
          <h5 class="mb-3">Archives</h5>

          <a
            href="{{ collateral.archive_file.url }}"
            class="btn btn-outline-dark btn-wrap"
            target="_blank"
            rel="noopener"
          >
            View Archive File
          </a>
        </div>
      {% endif %}

      <!-- ✅ 7) Webinar -->
      {% if collateral.webinar_title or collateral.webinar_url or collateral.webinar_description or collateral.webinar_date %}
        <hr class="my-4" />
        <div class="text-start">
          <h5 class="mb-3">Webinar</h5>

          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                  <h6 class="mb-1">
                    {{ collateral.webinar_title|default:"Learning Webinar" }}
                  </h6>

                  {% if collateral.webinar_date %}
                    <small class="text-muted">
                      {{ collateral.webinar_date|date:"F Y" }}
                    </small>
                  {% endif %}

                  {% if collateral.webinar_description %}
                    <p class="mt-2 mb-0">{{ collateral.webinar_description }}</p>
                  {% endif %}
                </div>

                {% if collateral.webinar_url %}
                  <a
                    class="btn btn-outline-primary btn-wrap"
                    href="{{ collateral.webinar_url }}"
                    target="_blank"
                    rel="noopener"
                  >
                    View on DIAP
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- ✅ 8) Banner 2 -->
      {% if collateral.banner_2 %}
        <div class="mt-4">
          <img
            src="{{ collateral.banner_2.url }}"
            alt="Banner 2"
            class="img-fluid w-100 rounded"
            style="object-fit: cover; max-height: 220px;"
          />
        </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- ✅ Engagement logger -->
<script type="application/json" id="engagementId">
  {{ engagement_id|json_script:"engagementId" }}
</script>

<script>
  const engagement = JSON.parse(document.getElementById("engagementId").textContent);

  function logEngagement(payload) {
    payload.engagement_id = engagement;
    fetch("{% url 'doctor_view_log' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
  }
</script>

{% endblock %}
