{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid" style="min-height: 100vh; background: #f8f9fa">
  <div class="row h-100">

    <!-- Left side: Content Preview -->
    <div class="col-md-8 p-0">
      {% if pdf_preview_url or pdf_preview_image %}
      <div
        class="preview-container"
        style="height: 100vh; border-right: 1px solid #dee2e6"
      >
        <div class="preview-header bg-primary text-white p-3">
          <h5 class="mb-0">
            {% if collateral.type == 'pdf' %}
              <i class="fas fa-file-pdf me-2"></i>
            {% elif collateral.type == 'jpg' or collateral.type == 'jpeg' or collateral.type == 'png' or collateral.type == 'gif' or collateral.type == 'bmp' %}
              <i class="fas fa-image me-2"></i>
            {% elif collateral.type == 'mp4' or collateral.type == 'video' %}
              <i class="fas fa-video me-2"></i>
            {% else %}
              <i class="fas fa-file me-2"></i>
            {% endif %}
            {{ collateral.title }} - Preview
          </h5>
          <small>Content preview â€¢ Verify your WhatsApp number to access full content</small>
          {% if pdf_preview_url %}
            <br />
            <small class="text-light">URL: {{ pdf_preview_url|truncatechars:50 }}</small>
          {% endif %}
        </div>

        <div class="content-preview" style="height: calc(100vh - 80px); overflow: hidden">
          {% if pdf_preview_image %}
          <!-- Preview image -->
          <div
            style="
              width: 100%;
              height: 100%;
              text-align: center;
              padding: 10px;
              background: #f8f9fa;
            "
          >
            <img
              src="{{ pdf_preview_image }}"
              alt="Content Preview"
              style="
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                border-radius: 8px;
              "
            />
          </div>
          {% else %}
          <!-- Direct content link fallback -->
          <div
            style="
              width: 100%;
              height: 100%;
              text-align: center;
              padding: 20px;
              display: flex;
              align-items: center;
              justify-content: center;
              background: #f8f9fa;
            "
          >
            <div style="max-width: 420px">
              <div
                style="
                  background: white;
                  padding: 30px;
                  border-radius: 10px;
                  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                "
              >
                <h5 class="mb-3">Preview available</h5>
                {% if pdf_preview_url %}
                <a class="btn btn-outline-primary" href="{{ pdf_preview_url }}" target="_blank" rel="noopener">
                  Open Preview in New Tab
                </a>
                {% endif %}
                <p class="text-muted mt-3 mb-0">
                  Verify your WhatsApp number on the right to unlock full content.
                </p>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
      {% else %}
      <!-- If no preview available -->
      <div
        class="preview-container"
        style="height: 100vh; border-right: 1px solid #dee2e6"
      >
        <div class="preview-header bg-primary text-white p-3">
          <h5 class="mb-0"><i class="fas fa-file me-2"></i>Content Preview</h5>
          <small>Verify your WhatsApp number to access content</small>
        </div>
        <div
          class="content-preview"
          style="
            height: calc(100vh - 80px);
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
          "
        >
          <div class="text-center text-muted">
            <i class="fas fa-lock fa-3x mb-3"></i>
            <p class="mb-0">Preview is not available for this content.</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Right side: Verification Form -->
    <div class="col-md-4 d-flex align-items-center justify-content-center">
      <div class="card shadow" style="width: 100%; max-width: 400px; margin: 2rem">
        <div class="card-body p-4">
          <h3 class="text-center mb-2">Verify Access</h3>
          <p class="text-center text-muted mb-4">
            Enter your WhatsApp number to unlock the content
          </p>

          {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
          {% endif %}

          <form method="post">
            {% csrf_token %}

            <div class="mb-3">
              <label for="whatsapp_number" class="form-label">WhatsApp Number</label>
              <input
                type="tel"
                class="form-control form-control-lg"
                id="whatsapp_number"
                name="whatsapp_number"
                placeholder="Enter 10-digit number"
                pattern="\d{10}"
                maxlength="10"
                required
                style="border-radius: 10px"
              />
              <input type="hidden" name="short_link_id" value="{{ short_link_id|default:'' }}" />
              <small class="form-text text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Enter the 10-digit number used for sharing
              </small>
            </div>

            <button
              type="submit"
              class="btn btn-primary btn-lg w-100 mb-3"
              style="
                background: linear-gradient(45deg, #1877f2, #42a5f5);
                border: none;
                border-radius: 10px;
              "
            >
              <i class="fas fa-unlock me-2"></i>
              Verify & Access Content
            </button>

            <div class="text-center">
              <small class="text-muted">
                <i class="fas fa-lock me-1"></i>
                Secure verification required
              </small>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .preview-container {
    position: relative;
  }

  .preview-header {
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .content-fallback {
    display: none;
    height: calc(100vh - 80px);
    background: #f8f9fa;
  }

  .content-fallback.show {
    display: block;
  }

  @media (max-width: 768px) {
    .row {
      flex-direction: column-reverse;
    }

    .col-md-8 {
      height: 50vh;
    }

    .col-md-4 {
      height: 50vh;
    }

    .content-preview {
      height: calc(50vh - 80px) !important;
    }

    .content-fallback {
      height: calc(50vh - 80px) !important;
    }
  }
</style>
{% endblock %}
