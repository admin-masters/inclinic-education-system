{% extends "base.html" %}
{% load static %}

{% block content %}
{% if verified and collateral %}

<div class="container mt-4">
  <div class="card mx-auto" style="max-width: 900px">

    {% comment %} Debug Info {% endcomment %}
    <h6 style="color:red;">
      debug engagement_id = {{ engagement_id|default:"NONE" }}
      {{ share_id|json_script:"share_id" }}
    </h6>

    <div class="card-header text-center">
      <h4 class="mb-0">{{ collateral.title }}</h4>

      {% if collateral.description %}
        <p class="text-muted mb-0">{{ collateral.description }}</p>
      {% endif %}

      {% if collateral.doctor_name %}
        <p class="text-muted mb-0">By Dr. {{ collateral.doctor_name }}</p>
      {% endif %}
    </div>

    <div class="card-body text-center">

      {% if collateral.banner_1 or collateral.banner_2 %}
        <div class="mb-4">
          {% if collateral.banner_1 %}
            <div class="mb-3">
              <img
                src="{{ collateral.banner_1.url }}"
                alt="{{ collateral.title }} banner"
                class="img-fluid w-100 rounded"
                style="object-fit: cover; max-height: 300px;"
              />
            </div>
          {% endif %}

          {% if collateral.banner_2 %}
            <div>
              <img
                src="{{ collateral.banner_2.url }}"
                alt="{{ collateral.title }} secondary banner"
                class="img-fluid w-100 rounded"
                style="object-fit: cover; max-height: 180px;"
              />
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% if collateral.vimeo_url %}
        <div class="ratio ratio-16x9 mb-3">
          {% if "vimeo.com" in collateral.vimeo_url %}
            <iframe src="{{ collateral.vimeo_url }}" allowfullscreen></iframe>
          {% else %}
            <iframe src="https://player.vimeo.com/video/{{ collateral.vimeo_url }}" allowfullscreen></iframe>
          {% endif %}
        </div>
      {% endif %}

      {% if collateral.file %}
        <a
          href="{{ absolute_pdf_url|default:'#' }}"
          class="btn btn-primary mb-3"
          target="_blank"
          rel="noopener"
          style="background: #1877f2; border: none"
          onclick="sendEngagement({ event: 'clicked_pdf_button' })"
        >
          CLICK HERE to download the PDF
        </a>

        <p>If you are not able to see the PDF, please refresh the page!</p>

        <div
          class="pdf-container mb-4"
          style="
            border: 1px solid #ccc;
            height: 600px;
            overflow: hidden;
            position: relative;
            background: #f8f9fa;
          "
        >
          <div
            class="pdf-controls"
            style="
              background: white;
              padding: 10px;
              border-bottom: 1px solid #ddd;
              display: flex;
              gap: 10px;
              align-items: center;
              justify-content: center;
            "
          >
            <a
              href="{{ absolute_pdf_url|default:'#' }}"
              class="btn btn-outline-secondary btn-sm"
              target="_blank"
              rel="noopener"
              onclick="sendEngagement({ event: 'open_pdf_new_tab' })"
            >
              Open in New Tab
            </a>

            <a
              href="{{ absolute_pdf_url|default:'#' }}"
              class="btn btn-outline-success btn-sm"
              download
              onclick="sendEngagement({ event: 'pdf_download' })"
            >
              Download
            </a>
          </div>

          <div class="pdf-scroll-box" style="height: calc(100% - 50px); overflow: auto; position: relative">
            <iframe
              src="{{ absolute_pdf_url|default:'about:blank' }}"
              width="100%"
              height="100%"
              style="border: none; min-height: 100%"
            ></iframe>
          </div>
        </div>
      {% endif %}

      {% if archives %}
        <hr class="my-4" />
        <div class="text-start">
          <h5 class="mb-3">Archives</h5>
          <div class="row g-3">
            {% for item in archives %}
              <div class="col-12 col-md-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title">{{ item.obj.title }}</h6>
                  </div>
                  <div class="card-footer bg-white border-0">
                    {% if item.short_code %}
                      <a
                        class="btn btn-sm btn-outline-primary w-100"
                        href="{% url 'resolve_shortlink' item.short_code %}"
                        onclick="sendEngagement({ event: 'archive_open' })"
                      >
                        Open
                      </a>
                    {% else %}
                      <button class="btn btn-sm btn-outline-secondary w-100" disabled>
                        No link available
                      </button>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if collateral.webinar_title or collateral.webinar_url %}
        <hr class="my-4" />
        <div class="text-start">
          <h5 class="mb-3">Webinar</h5>
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">
                    {{ collateral.webinar_title|default:"Learning Webinar" }}
                  </h6>

                  {% if collateral.webinar_date %}
                    <small class="text-muted">{{ collateral.webinar_month_year }}</small>
                  {% endif %}

                  {% if collateral.webinar_description %}
                    <p class="mt-2 mb-0">{{ collateral.webinar_description }}</p>
                  {% endif %}
                </div>

                {% if collateral.webinar_url %}
                  <a
                    class="btn btn-outline-primary"
                    href="{{ collateral.webinar_url }}"
                    target="_blank"
                    rel="noopener"
                    onclick="sendEngagement({ event: 'webinar_open' })"
                  >
                    View on DIAP
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}

    </div>
  </div>
</div>

{% if engagement_id %}
  {{ engagement_id|json_script:"engagement_id" }}
{% endif %}

<script>
  const engagement = JSON.parse(document.getElementById("engagement_id").textContent);

  const shareEl = document.getElementById("share_id");
  const shareId = shareEl ? JSON.parse(shareEl.textContent) : null;

  function sendEngagement(payload) {
    if (!engagement) return;

    payload.engagement_id = engagement;

    if (shareId) {
      payload.share_id = shareId;
    }

    fetch("{% url 'doctor_view_log' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    }).catch(() => {});
  }
</script>

<script>
  let sent_level = 0;
  const pdfScrollBox = document.querySelector(".pdf-scroll-box");

  if (pdfScrollBox) {
    pdfScrollBox.addEventListener("scroll", function () {
      const scrollTop = pdfScrollBox.scrollTop;
      const maxScroll = pdfScrollBox.scrollHeight - pdfScrollBox.clientHeight;

      if (maxScroll <= 0) return;

      const ratio = scrollTop / maxScroll;

      if (ratio > 0.5 && sent_level < 1) {
        sent_level = 1;
        sendEngagement({ event: "page_scroll", value: 1 });
      }

      if (ratio > 0.9 && sent_level < 2) {
        sent_level = 2;
        sendEngagement({ event: "page_scroll", value: 2 });
      }
    });
  }
</script>

{% if collateral.vimeo_url %}
  <script src="https://player.vimeo.com/api/player.js"></script>

  <script>
    const vimeoFrame = document.querySelector("iframe[src*='vimeo']");
    if (vimeoFrame && window.Vimeo) {
      const player = new Vimeo.Player(vimeoFrame);
      let lastSent = -1;

      player.on("timeupdate", function (data) {
        const percent = Math.floor((data.percent || 0) * 100);

        if (percent !== lastSent) {
          lastSent = percent;

          sendEngagement({
            event: "video_progress",
            value: percent
          });
        }
      });
    }
  </script>
{% endif %}

{% else %}

<div
  class="d-flex justify-content-center align-items-center"
  style="min-height: 80vh; background: #fff"
>
  <div class="card shadow" style="width: 100%; max-width: 400px">
    <div class="card-body p-4">
      <h3 class="text-center mb-4">Access Denied</h3>
      <p class="text-center text-muted">
        Please verify your WhatsApp number to access this content.
      </p>
      <a
        href="{% url 'doctor_collateral_verify' %}"
        class="btn btn-primary w-100"
        style="background: #1877f2; border: none"
      >
        Go Back to Verification
      </a>
    </div>
  </div>
</div>

{% endif %}
{% endblock %}
