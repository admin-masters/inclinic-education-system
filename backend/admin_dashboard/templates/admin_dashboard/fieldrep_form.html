{% extends "base.html" %}

{% block title %}
  {% if view.object %}Edit{% else %}Add{% endif %} Field Rep Â· Inditech
{% endblock %}

{% block content %}
<h2 class="mb-4">
  {% if view.object %}Edit{% else %}Add{% endif %} Field Rep
</h2>

<form method="post" class="needs-validation" novalidate>
  {% csrf_token %}

  <div class="mb-3">
    <label class="form-label" for="campaignSelect">Assign to Campaign (optional)</label>
    <div class="dropdown w-100">
      <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start"
              type="button"
              id="campaignDropdownBtn"
              data-bs-toggle="dropdown"
              aria-expanded="false">
        {% if campaign_param %}
          Selected Campaign: {{ campaign_param }}
        {% else %}
          Select campaign
        {% endif %}
      </button>

      <ul class="dropdown-menu w-100 p-2" aria-labelledby="campaignDropdownBtn" style="max-height: 250px; overflow-y: auto;">
        <!-- Search box inside dropdown -->
        <li>
          <input type="text"
                 class="form-control"
                 id="campaignSearchInput"
                 placeholder="Search campaign..."
                 onkeyup="filterCampaignDropdown()">
        </li>

        <li><hr class="dropdown-divider"></li>

        <!-- Campaign options -->
        {% for c in campaigns %}
          <li>
            <a class="dropdown-item campaign-option"
               href="#"
               data-value="{{ c.brand_campaign_id }}">
              {{ c.name }} ({{ c.brand_campaign_id }})
            </a>
          </li>
        {% endfor %}
      </ul>

      <!-- Hidden input that stores selected campaign id -->
      <input type="hidden" name="campaign" id="campaignSelect" value="{{ campaign_param|default:'' }}">
    </div>

    <script>
      function filterCampaignDropdown() {
        const input = document.getElementById("campaignSearchInput");
        const filter = input.value.toLowerCase();
        const items = document.querySelectorAll(".campaign-option");

        items.forEach(item => {
          const text = item.textContent.toLowerCase();
          item.parentElement.style.display = text.includes(filter) ? "" : "none";
        });
      }

      // Handle campaign selection
      document.querySelectorAll(".campaign-option").forEach(option => {
        option.addEventListener("click", function(e) {
          e.preventDefault();

          const selectedValue = this.getAttribute("data-value");
          const selectedText = this.textContent.trim();

          // Update hidden input
          document.getElementById("campaignSelect").value = selectedValue;

          // Update button label
          document.getElementById("campaignDropdownBtn").textContent = selectedText;
        });
      });
    </script>
  </div>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  {# Render fields explicitly to control order/layout #}
  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label" for="{{ form.first_name.id_for_label }}">{{ form.first_name.label }}</label>
      {{ form.first_name }}
      {% if form.first_name.errors %}
        <div class="text-danger">{{ form.first_name.errors }}</div>
      {% endif %}
    </div>

    <div class="col-md-6 mb-3">
      <label class="form-label" for="{{ form.last_name.id_for_label }}">{{ form.last_name.label }}</label>
      {{ form.last_name }}
      {% if form.last_name.errors %}
        <div class="text-danger">{{ form.last_name.errors }}</div>
      {% endif %}
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label" for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
    {{ form.email }}
    {% if form.email.errors %}
      <div class="text-danger">{{ form.email.errors }}</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label" for="{{ form.phone_number.id_for_label }}">{{ form.phone_number.label }}</label>
    {{ form.phone_number }}
    {% if form.phone_number.errors %}
      <div class="text-danger">{{ form.phone_number.errors }}</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label" for="{{ form.field_id.id_for_label }}">{{ form.field_id.label }}</label>
    {{ form.field_id }}
    {% if form.field_id.errors %}
      <div class="text-danger">{{ form.field_id.errors }}</div>
    {% endif %}
  </div>

  <button class="btn btn-success">
    {% if view.object %}Update{% else %}Add{% endif %}
  </button>

  <a href="{% url 'admin_dashboard:fieldrep_list' %}{% if campaign_param %}?brand_campaign_id={{ campaign_param }}{% endif %}"
     class="btn btn-secondary ms-2">
    Back
  </a>
</form>
{% endblock %}
