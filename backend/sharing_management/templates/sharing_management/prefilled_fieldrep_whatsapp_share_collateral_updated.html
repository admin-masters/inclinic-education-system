{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container" style="max-width: 960px;">
  <div class="row g-4">
    <div class="col-12 col-lg-4">
      <div class="card shadow">
        <div class="card-header text-center">
          <h5 class="mb-0">Share Collaterals</h5>
        </div>
        <div class="card-body p-4">
          <form method="post" autocomplete="off" id="shareForm">
            {% csrf_token %}
            <input type="hidden" name="brand_campaign_id" value="{{ brand_campaign_id }}">
            <div class="mb-3">
              <label class="form-label">Field ID:</label>
              <input type="text" class="form-control" name="fieldrep_id" value="{{ fieldrep_id }}" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Select Doctor:</label>
              <select class="form-select" name="doctor_id" id="doctorSelect" required>
                <option value="">Select Doctor</option>
                {% for d in doctors %}
                <option value="{{ d.id }}" data-name="{{ d.name }}" data-phone="{{ d.phone }}">{{ d.name }} / {{ d.phone }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Name of Doctor:</label>
              <input type="text" class="form-control" id="doctorName" name="doctor_name" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Doctor Phone Number:</label>
              <input type="text" class="form-control" id="doctorPhone" name="doctor_phone" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Select Active Collaterals:</label>
              <select class="form-select" name="collateral" id="collateralSelect" required>
                <option value="">Select Collateral</option>
                {% for c in collaterals %}
                <option value="{{ c.id }}" 
                        data-name="{{ c.name }}"
                        data-description="{{ c.description|default:'' }}"
                        data-url="{{ c.url|default:'' }}"
                        {% if c.id == selected_collateral_id|add:0 %}selected{% endif %}>
                  {{ c.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Message:</label>
              <textarea class="form-control" id="message" name="message" rows="3" required>Hello Doctor, please find the collateral shared with you.</textarea>
            </div>
            <button type="submit" class="btn btn-success w-100">
              <i class="fab fa-whatsapp me-2"></i>Send WhatsApp Message
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Assigned Doctors</h6>
          <div class="d-flex gap-2">
            <input type="text" id="doctorSearch" class="form-control form-control-sm" placeholder="Search by name or phone">
            <select id="statusFilter" class="form-select form-select-sm" style="width:auto;">
              <option value="">All</option>
              <option value="not_shared">Not Shared</option>
              <option value="shared">Shared</option>
              <option value="viewed">Viewed</option>
              <option value="needs_reminder">Needs Reminder</option>
            </select>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="doctorList">
            {% for d in doctors %}
            <div class="list-group-item d-flex justify-content-between align-items-center doctor-row"
                 data-id="{{ d.id }}"
                 data-name="{{ d.name|lower }}" 
                 data-phone="{{ d.phone }}" 
                 data-status="{{ d.status|default:'not_shared' }}"
                 data-last-shared="{{ d.last_shared|date:'c'|default:'' }}">
              <div>
                <div class="fw-semibold">{{ d.name|default:'Unnamed Doctor' }}</div>
                <div class="text-muted small">
                  {{ d.phone|default:'No phone' }}
                  {% if d.specialty %}| {{ d.specialty }}{% endif %}
                  {% if d.city %}| {{ d.city }}{% endif %}
                </div>
                {% if d.last_shared %}
                <div class="last-shared-time text-muted small mt-1">
                  Last shared: <span class="time-ago">{{ d.last_shared|timesince }} ago</span>
                </div>
                {% endif %}
              </div>
              <div class="d-flex align-items-center gap-2">
                <form method="post" class="m-0 share-form" data-doctor-id="{{ d.id }}">
                  {% csrf_token %}
                  <input type="hidden" name="doctor_id" value="{{ d.id }}">
                  <input type="hidden" name="collateral" value="{{ selected_collateral_id }}">
                  {% if d.status == 'viewed' %}
                    <button type="button" class="btn btn-success btn-sm" disabled>
                      <i class="fas fa-check-circle me-1"></i> Viewed
                    </button>
                  {% elif d.status == 'needs_reminder' %}
                    <button type="submit" class="btn btn-purple btn-sm" style="background:#6f42c1;border:none;color:#fff;" data-status="needs_reminder">
                      <i class="fas fa-bell me-1"></i> Send Reminder
                    </button>
                  {% elif d.status == 'shared' %}
                    <button type="button" class="btn btn-warning btn-sm" disabled data-status="shared">
                      <i class="fas fa-paper-plane me-1"></i> Shared
                    </button>
                  {% else %}
                    <button type="submit" class="btn btn-danger btn-sm" data-status="not_shared">
                      <i class="fas fa-paper-plane me-1"></i> Send Message
                    </button>
                  {% endif %}
                </form>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Button styles */
  .btn[data-status="not_shared"] {
    background-color: #dc3545;
    color: white;
    border: none;
  }
  
  .btn[data-status="shared"] {
    background-color: #ffc107;
    color: #000;
    border: none;
    opacity: 0.7;
  }
  
  .btn[data-status="viewed"] {
    background-color: #198754;
    color: white;
    border: none;
    opacity: 0.7;
  }
  
  .btn[data-status="needs_reminder"] {
    background-color: #6f42c1;
    color: white;
    border: none;
  }
  
  .btn:disabled {
    opacity: 0.7;
  }
  
  /* WhatsApp green color for the main button */
  .btn-success {
    background-color: #25D366 !important;
    border-color: #25D366 !important;
  }
  
  /* Animation for the bell icon */
  @keyframes ring {
    0% { transform: rotate(0); }
    10% { transform: rotate(30deg); }
    20% { transform: rotate(-30deg); }
    30% { transform: rotate(30deg); }
    40% { transform: rotate(-30deg); }
    50%, 100% { transform: rotate(0); }
  }
  
  .btn-purple .fa-bell {
    animation: ring 1s ease-in-out;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    const doctorSelect = document.getElementById('doctorSelect');
    const doctorName = document.getElementById('doctorName');
    const doctorPhone = document.getElementById('doctorPhone');
    const collateralSelect = document.getElementById('collateralSelect');
    const messageInput = document.getElementById('message');
    const searchInput = document.getElementById('doctorSearch');
    const statusFilter = document.getElementById('statusFilter');
    const doctorRows = document.querySelectorAll('.doctor-row');
    
    // Initialize doctor select dropdown
    if (doctorSelect) {
      doctorSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (doctorName) doctorName.value = selectedOption.getAttribute('data-name') || '';
        if (doctorPhone) doctorPhone.value = selectedOption.getAttribute('data-phone') || '';
      });
      
      // Trigger change if there's a selected value
      if (doctorSelect.value) {
        doctorSelect.dispatchEvent(new Event('change'));
      }
    }
    
    // Handle form submissions
    document.querySelectorAll('.share-form').forEach(form => {
      form.addEventListener('submit', handleFormSubmit);
    });
    
    // Handle main form submission
    const shareForm = document.getElementById('shareForm');
    if (shareForm) {
      shareForm.addEventListener('submit', handleMainFormSubmit);
    }
    
    // Search and filter functionality
    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
    }
    
    if (statusFilter) {
      statusFilter.addEventListener('change', applyFilters);
    }
    
    // Initial filters and checks
    applyFilters();
    checkForReminders();
    
    // Check for reminders every hour
    setInterval(checkForReminders, 60 * 60 * 1000);
    
    // Handle main form submission (for the left panel form)
    async function handleMainFormSubmit(e) {
      e.preventDefault();
      
      const form = e.target;
      const button = form.querySelector('button[type="submit"]');
      const phoneInput = form.querySelector('input[name="doctor_phone"]');
      const message = form.querySelector('textarea[name="message"]').value;
      
      if (!phoneInput || !phoneInput.value) {
        alert('Please select a doctor with a valid phone number.');
        return;
      }
      
      // Clean phone number (remove all non-numeric characters)
      const cleanPhone = phoneInput.value.replace(/\D/g, '');
      
      if (!cleanPhone) {
        alert('Invalid phone number. Please check the doctor\'s phone number.');
        return;
      }
      
      // Create WhatsApp URL
      const waUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
      
      // Open WhatsApp in a new tab
      const waWindow = window.open(waUrl, '_blank');
      
      // Save original button state
      const originalHTML = button.innerHTML;
      
      try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
        
        // Send tracking request to server
        const formData = new FormData(form);
        
        const response = await fetch(form.action || window.location.href, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update the UI if we have the doctor's row
          const doctorId = form.querySelector('select[name="doctor_id"]')?.value;
          if (doctorId) {
            const row = document.querySelector(`.doctor-row[data-id="${doctorId}"]`);
            if (row) {
              updateDoctorStatus(row, 'shared');
              
              // Schedule reminder check
              setTimeout(() => {
                if (row.getAttribute('data-status') === 'shared') {
                  updateDoctorStatus(row, 'needs_reminder');
                }
              }, 6 * 24 * 60 * 60 * 1000); // 6 days
            }
          }
          
          // Show success message
          const successMsg = document.createElement('div');
          successMsg.className = 'alert alert-success mt-3 mb-0';
          successMsg.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            Message sent successfully! You can close the WhatsApp window when done.
          `;
          form.parentNode.insertBefore(successMsg, form.nextElementSibling);
          
          // Remove success message after 5 seconds
          setTimeout(() => {
            successMsg.remove();
          }, 5000);
          
          // Reset form
          form.reset();
          
        } else {
          throw new Error(data.message || 'Failed to send message');
        }
        
      } catch (error) {
        console.error('Error:', error);
        
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'alert alert-danger mt-3 mb-0';
        errorMsg.innerHTML = `
          <i class="fas fa-exclamation-circle me-2"></i>
          Failed to track the message. The message was still sent, but the status may not update correctly.
        `;
        form.parentNode.insertBefore(errorMsg, form.nextElementSibling);
        
        // Remove error message after 5 seconds
        setTimeout(() => {
          errorMsg.remove();
        }, 5000);
        
      } finally {
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
      
      // Focus WhatsApp window
      if (waWindow) {
        setTimeout(() => waWindow.focus(), 500);
      }
    }
    
    // Handle individual doctor row form submission
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const form = e.target;
      const button = form.querySelector('button[type="submit"]');
      const row = form.closest('.doctor-row');
      
      if (!button || button.disabled) return;
      
      // Save original button state
      const originalHTML = button.innerHTML;
      const originalStatus = button.getAttribute('data-status');
      
      try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        
        // Get doctor data
        const doctorId = form.getAttribute('data-doctor-id');
        const doctorName = row.querySelector('.fw-semibold').textContent.trim();
        const doctorPhone = row.getAttribute('data-phone');
        const collateralId = form.querySelector('input[name="collateral"]').value;
        
        if (!doctorPhone) {
          throw new Error('No phone number available for this doctor');
        }
        
        // Get collateral data
        const collateralOption = collateralSelect.querySelector(`option[value="${collateralId}"]`);
        if (!collateralOption) {
          throw new Error('Selected collateral not found');
        }
        
        const collateralName = collateralOption.getAttribute('data-name') || 'the collateral';
        const collateralUrl = collateralOption.getAttribute('data-url') || '#';
        
        // Create message
        const message = `Hello Dr. ${doctorName.split(' ')[0]}, here's the ${collateralName} we discussed: ${collateralUrl}`;
        
        // Clean phone number
        const cleanPhone = doctorPhone.replace(/\D/g, '');
        
        // Create WhatsApp URL
        const waUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
        
        // Open WhatsApp in a new tab
        const waWindow = window.open(waUrl, '_blank');
        
        // Update UI immediately for better UX
        updateDoctorStatus(row, 'shared');
        
        // Schedule reminder check
        setTimeout(() => {
          if (row.getAttribute('data-status') === 'shared') {
            updateDoctorStatus(row, 'needs_reminder');
          }
        }, 6 * 24 * 60 * 60 * 1000); // 6 days
        
        // Send tracking request to server
        try {
          const formData = new FormData(form);
          formData.append('message', message);
          
          const response = await fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
          });
          
          const data = await response.json();
          
          if (!data.success) {
            console.error('Tracking failed:', data.message);
            // Revert UI on error
            updateDoctorStatus(row, originalStatus);
            throw new Error(data.message || 'Failed to track message');
          }
          
          // Show success message
          const successMsg = document.createElement('div');
          successMsg.className = 'alert alert-success mt-2 mb-0';
          successMsg.textContent = 'Message sent! WhatsApp should open in a new tab.';
          row.parentNode.insertBefore(successMsg, row.nextSibling);
          
          // Remove success message after 5 seconds
          setTimeout(() => {
            successMsg.remove();
          }, 5000);
          
        } catch (error) {
          console.error('Error tracking share:', error);
          // Don't revert UI for tracking errors, as the message was still sent
        }
        
        // Focus WhatsApp window
        if (waWindow) {
          setTimeout(() => waWindow.focus(), 500);
        }
        
      } catch (error) {
        console.error('Error:', error);
        
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'alert alert-danger mt-2 mb-0';
        errorMsg.textContent = error.message || 'Failed to send message. Please try again.';
        row.parentNode.insertBefore(errorMsg, row.nextSibling);
        
        // Remove error message after 5 seconds
        setTimeout(() => {
          errorMsg.remove();
        }, 5000);
        
        // Revert button state
        if (button) {
          button.disabled = false;
          button.innerHTML = originalHTML;
        }
      }
    }
    
    // Update doctor status in the UI
    function updateDoctorStatus(row, status) {
      if (!row || !status) return;
      
      // Update data attributes
      row.setAttribute('data-status', status);
      
      if (status === 'shared' || status === 'viewed') {
        const now = new Date().toISOString();
        row.setAttribute('data-last-shared', now);
        
        // Update last shared time display
        let lastSharedDiv = row.querySelector('.last-shared-time');
        let timeAgoSpan = row.querySelector('.time-ago');
        
        if (!lastSharedDiv) {
          const infoDiv = row.querySelector('.text-muted');
          if (infoDiv) {
            lastSharedDiv = document.createElement('div');
            lastSharedDiv.className = 'last-shared-time text-muted small mt-1';
            lastSharedDiv.innerHTML = 'Last shared: <span class="time-ago">just now</span>';
            infoDiv.parentNode.insertBefore(lastSharedDiv, infoDiv.nextSibling);
            timeAgoSpan = lastSharedDiv.querySelector('.time-ago');
          }
        } else {
          lastSharedDiv.style.display = 'block';
          timeAgoSpan = timeAgoSpan || lastSharedDiv.querySelector('.time-ago');
          if (timeAgoSpan) timeAgoSpan.textContent = 'just now';
        }
      }
      
      // Update button
      const form = row.querySelector('form');
      if (!form) return;
      
      const button = form.querySelector('button[type="submit"]');
      if (!button) return;
      
      button.setAttribute('data-status', status);
      
      switch (status) {
        case 'shared':
          button.className = 'btn btn-warning btn-sm';
          button.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Shared';
          button.disabled = true;
          button.type = 'button';
          break;
          
        case 'viewed':
          button.className = 'btn btn-success btn-sm';
          button.innerHTML = '<i class="fas fa-check-circle me-1"></i> Viewed';
          button.disabled = true;
          button.type = 'button';
          break;
          
        case 'needs_reminder':
          button.className = 'btn btn-purple btn-sm';
          button.style = 'background:#6f42c1;border:none;color:#fff;';
          button.innerHTML = '<i class="fas fa-bell me-1"></i> Send Reminder';
          button.disabled = false;
          button.type = 'submit';
          break;
          
        default: // not_shared
          button.className = 'btn btn-danger btn-sm';
          button.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Send Message';
          button.disabled = false;
          button.type = 'submit';
      }
    }
    
    // Check for reminders (6 days after sharing)
    function checkForReminders() {
      const now = new Date();
      
      document.querySelectorAll('.doctor-row[data-last-shared]').forEach(row => {
        const lastShared = row.getAttribute('data-last-shared');
        const status = row.getAttribute('data-status');
        
        if (!lastShared || status !== 'shared') return;
        
        const lastDate = new Date(lastShared);
        const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
        
        if (diffDays >= 6) {
          updateDoctorStatus(row, 'needs_reminder');
        } else {
          // Update time display
          updateTimeAgo(row);
        }
      });
    }
    
    // Update time ago for a row
    function updateTimeAgo(row) {
      const lastShared = row.getAttribute('data-last-shared');
      const timeAgoSpan = row.querySelector('.time-ago');
      
      if (!lastShared || !timeAgoSpan) return;
      
      const lastDate = new Date(lastShared);
      const now = new Date();
      const diffMs = now - lastDate;
      const diffSecs = Math.floor(diffMs / 1000);
      const diffMins = Math.floor(diffSecs / 60);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      let timeAgo;
      if (diffSecs < 60) {
        timeAgo = 'just now';
      } else if (diffMins < 60) {
        timeAgo = `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
      } else if (diffHours < 24) {
        timeAgo = `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
      } else {
        timeAgo = `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
      }
      
      timeAgoSpan.textContent = timeAgo;
    }
    
    // Apply search and filter
    function applyFilters() {
      const searchTerm = (searchInput?.value || '').toLowerCase();
      const statusFilterValue = statusFilter?.value || '';
      
      doctorRows.forEach(row => {
        const name = (row.getAttribute('data-name') || '').toLowerCase();
        const phone = (row.getAttribute('data-phone') || '').toLowerCase();
        const status = row.getAttribute('data-status') || '';
        
        const matchesSearch = !searchTerm || 
                             name.includes(searchTerm) || 
                             phone.includes(searchTerm);
        
        const matchesStatus = !statusFilterValue || 
                             (statusFilterValue === 'not_sent' && !status) ||
                             status === statusFilterValue;
        
        row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
      });
    }
    
    // Update all time-ago displays every minute
    setInterval(() => {
      document.querySelectorAll('.doctor-row[data-last-shared]').forEach(updateTimeAgo);
    }, 60000);
    
    // Auto-submit the form if we have a doctor_id and collateral in the URL
    function checkAutoSubmit() {
      const urlParams = new URLSearchParams(window.location.search);
      const doctorId = urlParams.get('doctor_id');
      const collateralId = urlParams.get('collateral');
      
      if (doctorId && collateralId) {
        // Find the form for this doctor
        const form = document.querySelector(`form[data-doctor-id="${doctorId}"]`);
        if (form) {
          // Set the collateral value
          const collateralInput = form.querySelector('input[name="collateral"]');
          if (collateralInput) {
            collateralInput.value = collateralId;
          }
          
          // Submit the form
          form.dispatchEvent(new Event('submit'));
        }
      }
    }
    
    // Run auto-submit check after a short delay
    setTimeout(checkAutoSubmit, 1000);
  });
</script>
{% endblock %}
