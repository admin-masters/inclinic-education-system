{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="card mx-auto" style="max-width: 600px;">
    <div class="card-header text-center">
      <h2 class="mb-0">Edit Collateral Dates</h2>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <!-- Brand Campaign ID -->
        <div class="mb-3">
          <label class="form-label">Brand Campaign ID:</label>
          <input type="text" id="brand-campaign-id" class="form-control" value="{{ form.campaign.value|default:'' }}"
            readonly>
        </div>
        <!-- Select Collateral -->
        <div class="mb-3">
          <label class="form-label">Select Collateral:</label>
          {{ form.collateral }}
          <small class="text-muted">ID: {{ form.collateral.id_for_label }}</small>
        </div>
        <!-- Start Date -->
        <div class="mb-3">
          <label class="form-label">Start Date:</label>
          {{ form.start_date }}
        </div>
        <!-- End Date -->
        <div class="mb-3">
          <label class="form-label">End Date:</label>
          {{ form.end_date }}
        </div>
        <button type="submit" class="btn btn-primary">Update Dates</button>
        <a href="{% url 'fieldrep_dashboard' %}" class="btn btn-secondary ms-2">Cancel</a>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM loaded, setting up collateral selection handler...');

    const collateralSelect = document.getElementById('id_collateral');
    const brandCampaignIdField = document.getElementById('brand-campaign-id');
    const startDateField = document.getElementById('id_start_date');
    const endDateField = document.getElementById('id_end_date');

    console.log('Collateral select element:', collateralSelect);
    console.log('Brand campaign ID field:', brandCampaignIdField);
    console.log('Start date field:', startDateField);
    console.log('End date field:', endDateField);

    if (collateralSelect && brandCampaignIdField) {
      console.log('Required elements found, setting up event listeners...');

      // Set initial value if editing existing record
      if (collateralSelect.value) {
        console.log('Initial collateral value:', collateralSelect.value);
        updateCollateralData(collateralSelect.value);
      }

      // Add change event listener
      collateralSelect.addEventListener('change', function () {
        const selectedCollateralId = this.value;
        console.log('Collateral selection changed to:', selectedCollateralId);
        if (selectedCollateralId) {
          updateCollateralData(selectedCollateralId);
        } else {
          brandCampaignIdField.value = '';
          if (startDateField) startDateField.value = '';
          if (endDateField) endDateField.value = '';
        }
      });
    } else {
      console.error('Required elements not found!');
    }

    function updateCollateralData(collateralId) {
      console.log('Updating collateral data for collateral:', collateralId);
      const apiUrl = `/api/get-collateral-campaign/${collateralId}/`;
      console.log('API URL:', apiUrl);

      fetch(apiUrl)
        .then(response => {
          console.log('API response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('API response data:', data);
          if (data.success) {
            // Update brand campaign ID
            brandCampaignIdField.value = data.brand_campaign_id;
            console.log('Updated brand campaign ID to:', data.brand_campaign_id);
            
            // Update start date if available
            if (startDateField && data.start_date) {
              startDateField.value = data.start_date;
              console.log('Updated start date to:', data.start_date);
            }
            
            // Update end date if available
            if (endDateField && data.end_date) {
              endDateField.value = data.end_date;
              console.log('Updated end date to:', data.end_date);
            }
          } else {
            brandCampaignIdField.value = 'Error loading campaign ID';
            console.error('API error:', data.error);
          }
        })
        .catch(error => {
          console.error('Fetch error:', error);
          brandCampaignIdField.value = 'Error loading campaign ID';
        });
    }
  });
</script>
{% endblock %}