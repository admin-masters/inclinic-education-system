{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<!-- Custom styles (if any) -->
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card mx-auto" style="max-width: 800px;">
    <div class="card-header text-center">
      <h2 class="mb-0">Edit Collateral Dates</h2>
    </div>
    <div class="card-body">
      <div id="saveStatus" class="alert d-none" role="alert"></div>
      <form method="post" id="editCalendarForm" data-ajax="true" data-editing="{{ editing|yesno:'true,false' }}">
        {% csrf_token %}
        <!-- Brand Campaign ID -->
        <div class="mb-3">
          <label class="form-label">Brand Campaign ID:</label>
          {{ form.campaign }}
          <!-- Hidden field to ensure campaign is submitted even if visible input is disabled -->
          <input type="hidden" name="campaign" id="id_campaign_hidden" value="{{ form.initial.campaign|default:'' }}">
        </div>
        <!-- Select Collateral -->
        <div class="mb-3">
          <label class="form-label">Collateral Name:</label>
          {% if collateral %}
            <p class="form-control-static">{{ collateral.title }}</p>
            <input type="hidden" name="collateral" value="{{ collateral.id }}">
          {% else %}
            {% if form.collateral.field.queryset.exists %}
              {{ form.collateral }}
            {% else %}
              <div class="alert alert-warning">No collaterals found for this campaign.</div>
            {% endif %}
          {% endif %}
          {% if form.collateral.help_text %}
            <small class="form-text text-muted">{{ form.collateral.help_text }}</small>
          {% endif %}
          {% if form.collateral.errors %}
            <div class="invalid-feedback d-block">
              {{ form.collateral.errors }}
            </div>
          {% endif %}
        </div>
        <!-- Start Date -->
        <div class="mb-3">
          <label class="form-label">Start Date:</label>
          {{ form.start_date }}
        </div>
        <!-- End Date -->
        <div class="mb-3">
          <label class="form-label">End Date:</label>
          {{ form.end_date }}
        </div>
        <button type="submit" id="updateBtn" class="btn btn-primary">Update Dates</button>
        <a href="{% url 'fieldrep_dashboard' %}" class="btn btn-secondary ms-2">Cancel</a>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const isEditing = (document.getElementById('editCalendarForm')?.dataset?.editing === 'true');
    const startDateField = document.getElementById('id_start_date');
    const endDateField = document.getElementById('id_end_date');
    console.log('DOM loaded, setting up collateral selection handler...');

    const collateralSelect = document.getElementById('id_collateral');
    const brandCampaignIdField = document.getElementById('id_campaign');
    const brandCampaignHiddenField = document.getElementById('id_campaign_hidden');
    // isEditing already computed above

    console.log('Collateral select element:', collateralSelect);
    console.log('Brand campaign ID field:', brandCampaignIdField);
    console.log('Start date field:', startDateField);
    console.log('End date field:', endDateField);

    if (collateralSelect && brandCampaignIdField) {
      console.log('Required elements found, setting up event listeners...');

      // Set initial value if present
      if (collateralSelect.value) {
        console.log('Initial collateral value:', collateralSelect.value);
        // Only update collateral data if not editing AND dates are empty
        const hasPrefilledDates = (startDateField?.value || endDateField?.value);
        if (!isEditing && !hasPrefilledDates) {
          updateCollateralData(collateralSelect.value);
        }
      }

      // Add change event listener
      collateralSelect.addEventListener('change', function () {
        const selectedCollateralId = this.value;
        console.log('Collateral selection changed to:', selectedCollateralId);
        if (selectedCollateralId) {
          updateCollateralData(selectedCollateralId);
        } else {
          brandCampaignIdField.value = '';
          if (startDateField) startDateField.value = '';
          if (endDateField) endDateField.value = '';
        }
      });
    } else {
      console.error('Required elements not found!');
    }

    function updateCollateralData(collateralId) {
      console.log('Updating collateral data for collateral:', collateralId);
      const apiUrl = `/api/get-collateral-campaign/${collateralId}/`;
      console.log('API URL:', apiUrl);

      fetch(apiUrl)
        .then(response => {
          console.log('API response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('API response data:', data);
          if (data.success) {
            // Update brand campaign ID
            brandCampaignIdField.value = data.brand_campaign_id;
            if (brandCampaignHiddenField) {
              brandCampaignHiddenField.value = data.brand_campaign_id;
            }
            console.log('Updated brand campaign ID to:', data.brand_campaign_id);
            
            // Update start date if available
            if (startDateField && data.start_date) {
              startDateField.value = data.start_date;
              console.log('Updated start date to:', data.start_date);
            }
            
            // Update end date if available
            if (endDateField && data.end_date) {
              endDateField.value = data.end_date;
              console.log('Updated end date to:', data.end_date);
            }
          } else {
            brandCampaignIdField.value = 'Error loading campaign ID';
            console.error('API error:', data.error);
          }
        })
        .catch(error => {
          console.error('Fetch error:', error);
          brandCampaignIdField.value = 'Error loading campaign ID';
          if (brandCampaignHiddenField) {
            brandCampaignHiddenField.value = '';
          }
        });
    }

    // AJAX form submit without page reload
    const formEl = document.getElementById('editCalendarForm');
    const updateBtn = document.getElementById('updateBtn');
    const statusEl = document.getElementById('saveStatus');

    function getCsrfToken() {
      const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
      return tokenInput ? tokenInput.value : '';
    }

    if (formEl) {
      formEl.addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(formEl);
        const payload = new URLSearchParams();
        for (const [k, v] of formData.entries()) {
          payload.append(k, v);
        }

        // UI: disable button, clear status
        if (updateBtn) {
          updateBtn.disabled = true;
          updateBtn.textContent = 'Saving...';
        }
        if (statusEl) {
          statusEl.classList.add('d-none');
          statusEl.classList.remove('alert-success', 'alert-danger');
          statusEl.textContent = '';
        }

        fetch(window.location.href, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: payload.toString(),
        })
          .then(async (res) => {
            const data = await res.json().catch(() => ({}));
            if (res.ok && data && data.success) {
              // Update fields with saved values
              if (data.start_date && startDateField) startDateField.value = data.start_date;
              if (data.end_date && endDateField) endDateField.value = data.end_date;
              if (brandCampaignIdField && data.brand_campaign_id) brandCampaignIdField.value = data.brand_campaign_id;

              // Show success
              if (statusEl) {
                statusEl.textContent = 'Updated successfully.';
                statusEl.classList.remove('d-none');
                statusEl.classList.add('alert', 'alert-success');
              }
            } else {
              // Show errors
              const errText = (data && data.errors) ? JSON.stringify(data.errors) : 'Save failed.';
              if (statusEl) {
                statusEl.textContent = errText;
                statusEl.classList.remove('d-none');
                statusEl.classList.add('alert', 'alert-danger');
              }
            }
          })
          .catch((err) => {
            console.error('Save error', err);
            if (statusEl) {
              statusEl.textContent = 'Error while saving.';
              statusEl.classList.remove('d-none');
              statusEl.classList.add('alert', 'alert-danger');
            }
          })
          .finally(() => {
            if (updateBtn) {
              updateBtn.disabled = false;
              updateBtn.textContent = 'Update Dates';
            }
          });
      });
    }
  });
</script>
{% endblock %}