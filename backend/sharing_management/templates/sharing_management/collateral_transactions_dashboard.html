{% extends "base.html" %}
{% load static %}

{% block content %}
{% if verified and collateral %}

<div class="container mt-4">
  <div class="card mx-auto" style="max-width: 900px">

    <div class="card-header text-center">
      <h4 class="mb-0">{{ collateral.title }}</h4>

      {% if collateral.description %}
        <p class="text-muted mb-0">{{ collateral.description }}</p>
      {% endif %}

      {% if collateral.doctor_name %}
        <p class="text-muted mb-0">By Dr. {{ collateral.doctor_name }}</p>
      {% endif %}
    </div>

    <div class="card-body text-center">

      {% if collateral.banner_1 or collateral.banner_2 %}
        <div class="mb-4">
          {% if collateral.banner_1 %}
            <div class="mb-3">
              <img
                src="{{ collateral.banner_1.url }}"
                alt="{{ collateral.title }} banner"
                class="img-fluid w-100 rounded"
                style="object-fit: cover; max-height: 300px;"
              />
            </div>
          {% endif %}

          {% if collateral.banner_2 %}
            <div>
              <img
                src="{{ collateral.banner_2.url }}"
                alt="{{ collateral.title }} secondary banner"
                class="img-fluid w-100 rounded"
                style="object-fit: cover; max-height: 180px;"
              />
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% if collateral.vimeo_url %}
        <div class="ratio ratio-16x9 mb-3">
          {% if "vimeo.com" in collateral.vimeo_url %}
            <iframe src="{{ collateral.vimeo_url }}" allowfullscreen></iframe>
          {% else %}
            <iframe src="https://player.vimeo.com/video/{{ collateral.vimeo_url }}" allowfullscreen></iframe>
          {% endif %}
        </div>
      {% endif %}

      {% if collateral.file %}
        <div class="mb-3 d-flex justify-content-center gap-2 flex-wrap">
          <a
            href="{{ absolute_pdf_url|default:'#' }}"
            class="btn btn-outline-success"
            download
            id="downloadPdfBtn"
          >
            Download PDF
          </a>
        </div>

        <p class="text-muted">
          If PDF is not loading properly, please refresh the page.
        </p>

        <div
          id="pdfBox"
          class="border rounded mb-4"
          style="height: 600px; overflow-y: auto; display: block; background: #f8f9fa;"
        >
          <div id="pdfViewer" class="p-2"></div>
        </div>

        <div class="mt-2 text-muted small" id="pdfProgressText" style="display:none;">
          Loading PDF...
        </div>
      {% endif %}

      {% if archives %}
        <hr class="my-4" />
        <div class="text-start">
          <h5 class="mb-3">Archives</h5>
          <div class="row g-3">
            {% for item in archives %}
              <div class="col-12 col-md-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title">{{ item.obj.title }}</h6>
                  </div>
                  <div class="card-footer bg-white border-0">
                    {% if item.short_code %}
                      <a
                        class="btn btn-sm btn-outline-primary w-100"
                        href="{% url 'resolve_shortlink' item.short_code %}"
                        onclick="sendEngagement({ event: 'archive_open' })"
                      >
                        Open
                      </a>
                    {% else %}
                      <button class="btn btn-sm btn-outline-secondary w-100" disabled>
                        No link available
                      </button>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if collateral.webinar_title or collateral.webinar_url %}
        <hr class="my-4" />
        <div class="text-start">
          <h5 class="mb-3">Webinar</h5>
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">
                    {{ collateral.webinar_title|default:"Learning Webinar" }}
                  </h6>

                  {% if collateral.webinar_date %}
                    <small class="text-muted">{{ collateral.webinar_month_year }}</small>
                  {% endif %}

                  {% if collateral.webinar_description %}
                    <p class="mt-2 mb-0">{{ collateral.webinar_description }}</p>
                  {% endif %}
                </div>

                {% if collateral.webinar_url %}
                  <a
                    class="btn btn-outline-primary"
                    href="{{ collateral.webinar_url }}"
                    target="_blank"
                    rel="noopener"
                    onclick="sendEngagement({ event: 'webinar_open' })"
                  >
                    View on DIAP
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}

    </div>
  </div>
</div>

{{ share_id|json_script:"share_id" }}
{{ engagement_id|json_script:"engagement_id" }}

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
  const el = document.getElementById("engagement_id");
  const engagement = el ? JSON.parse(el.textContent) : null;

  const shareEl = document.getElementById("share_id");
  const shareId = shareEl ? JSON.parse(shareEl.textContent) : null;

  function sendEngagement(payload) {
    if (!engagement) return;

    const body = {
      engagement_id: engagement,
      share_id: shareId,
      ...payload
    };

    fetch("{% url 'doctor_view_log' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    }).catch(() => {});
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  sendEngagement({ event: "clicked", value: 1 });
});
</script>

<script>
  const downloadPdfBtn = document.getElementById("downloadPdfBtn");
  const pdfBox = document.getElementById("pdfBox");
  const pdfViewer = document.getElementById("pdfViewer");
  const pdfProgressText = document.getElementById("pdfProgressText");

  let pdfDoc = null;
  let totalPages = 0;
  let maxPageReached = 1;
  let lastSentLevel = 0;

  function computeScrollLevel(maxPage, total) {
    if (!total || total <= 1) return 0;
    if (maxPage <= 1) return 0;

    const half = Math.ceil(total / 2);

    if (maxPage >= total) return 2;
    if (maxPage >= half) return 1;
    return 0;
  }

  async function renderPdf(url) {
    pdfViewer.innerHTML = "";
    maxPageReached = 1;
    lastSentLevel = 0;

    pdfProgressText.style.display = "block";
    pdfProgressText.textContent = "Loading PDF...";

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    pdfDoc = await pdfjsLib.getDocument(url).promise;
    totalPages = pdfDoc.numPages;

    sendEngagement({
      event: "pdf_auto_open",
      value: 1,
      pdf_total_pages: totalPages
    });

    pdfProgressText.textContent = `PDF Loaded: ${totalPages} pages`;

    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
      const page = await pdfDoc.getPage(pageNum);

      const viewport = page.getViewport({ scale: 1.4 });
      const canvas = document.createElement("canvas");
      canvas.dataset.pageNumber = pageNum;

      const context = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "14px";
      wrapper.style.display = "flex";
      wrapper.style.justifyContent = "center";
      wrapper.appendChild(canvas);

      pdfViewer.appendChild(wrapper);

      await page.render({ canvasContext: context, viewport }).promise;
    }

    pdfProgressText.textContent = `Scroll to read (${totalPages} pages)`;
  }

  function detectMaxVisiblePage() {
    const canvases = pdfViewer.querySelectorAll("canvas[data-page-number]");
    let best = 1;

    const boxRect = pdfBox.getBoundingClientRect();

    canvases.forEach((c) => {
      const rect = c.getBoundingClientRect();
      const visible = rect.top < boxRect.bottom && rect.bottom > boxRect.top;

      if (visible) {
        const pageNum = parseInt(c.dataset.pageNumber || "1");
        if (pageNum > best) best = pageNum;
      }
    });

    return best;
  }

  let scrollTimer = null;
  function onPdfScroll() {
    if (scrollTimer) clearTimeout(scrollTimer);

    scrollTimer = setTimeout(() => {
      const visiblePage = detectMaxVisiblePage();
      maxPageReached = Math.max(maxPageReached, visiblePage);

      const level = computeScrollLevel(maxPageReached, totalPages);

      pdfProgressText.textContent =
        `Reached page ${maxPageReached}/${totalPages} (level=${level})`;

      if (level > lastSentLevel) {
        lastSentLevel = level;

        sendEngagement({
          event: "page_scroll",
          value: level,
          page_number: maxPageReached,
          pdf_total_pages: totalPages
        });
      }
    }, 250);
  }

  if (pdfBox) {
    pdfBox.addEventListener("scroll", onPdfScroll);
  }

  if (downloadPdfBtn) {
    downloadPdfBtn.addEventListener("click", () => {
      sendEngagement({ event: "pdf_download", value: 1 });
    });
  }

  // âœ… Auto-load PDF on page load
  window.addEventListener("load", async () => {
    const pdfUrl = "{{ absolute_pdf_url }}";
    if (!pdfUrl || pdfUrl === "#") return;

    try {
      await renderPdf(pdfUrl);
    } catch (e) {
      pdfProgressText.textContent = "Failed to load PDF. Please refresh.";
      sendEngagement({ event: "pdf_load_failed", value: 1 });
    }
  });
</script>

{% if collateral.vimeo_url %}
  <script src="https://player.vimeo.com/api/player.js"></script>

  <script>
    const vimeoFrame = document.querySelector("iframe[src*='vimeo']");
    if (vimeoFrame && window.Vimeo) {
      const player = new Vimeo.Player(vimeoFrame);

      let sent50 = false;
      let sent100 = false;

      player.on("timeupdate", function (data) {
        const percent = Math.floor((data.percent || 0) * 100);

        if (!sent50 && percent >= 50 && percent < 100) {
          sent50 = true;
          sendEngagement({
            event: "video_progress",
            value: 50
          });
        }

        if (!sent100 && percent >= 99) {
          sent100 = true;
          sendEngagement({
            event: "video_progress",
            value: 100
          });
        }
      });
    }
  </script>
{% endif %}

{% else %}

<div
  class="d-flex justify-content-center align-items-center"
  style="min-height: 80vh; background: #fff"
>
  <div class="card shadow" style="width: 100%; max-width: 400px">
    <div class="card-body p-4">
      <h3 class="text-center mb-4">Access Denied</h3>
      <p class="text-center text-muted">
        Please verify your WhatsApp number to access this content.
      </p>
      <a
        href="{% url 'doctor_collateral_verify' %}"
        class="btn btn-primary w-100"
        style="background: #1877f2; border: none"
      >
        Go Back to Verification
      </a>
    </div>
  </div>
</div>

{% endif %}

{% endblock %}
